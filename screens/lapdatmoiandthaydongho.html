<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Dashboard - Lắp Đặt Mới & Thay Đồng Hồ</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root {
            /* Colors */
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            --accent-blue: #3B82F6;
            --accent-green: #10B981;
            --accent-orange: #F59E0B;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 10vh 90vh;
        }

        /* === HEADER === */
        header {
            padding: 0 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border-bottom: 2px solid #E2E8F0;
        }

        .brand-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo {
            width: 56px;
            height: 56px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 2rem;
        }

        .brand-text h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-text p {
            font-size: 18px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .clock-container {
            text-align: right;
            background: #F1F5F9;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
        }

        .time {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-blue);
            font-variant-numeric: tabular-nums;
        }

        .date {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* === MAIN 2-COLUMN LAYOUT === */
        main {
            display: grid;
            grid-template-columns: 50fr 50fr;
            gap: 1rem;
            padding: 1rem 2rem;
            height: 100%;
        }

        /* === LEFT COLUMN: INFO CARDS GRID === */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-header::before {
            content: '';
            width: 5px;
            height: 28px;
            background: var(--primary-gradient);
            border-radius: 3px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Cards Grid - 2 columns x 3 rows */
        .cards-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .tv-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 0.5rem 0.75rem;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.08);
            border: 1px solid #F1F5F9;
            display: flex;
            flex-direction: column;
        }

        .tv-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #F1F5F9;
        }

        .tv-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            flex: 1;
        }

        .tv-card-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }

        .tv-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tv-metric {
            text-align: center;
        }

        .tv-metric-label {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            margin-bottom: 0.2rem;
        }

        .tv-metric-value {
            font-size: 22px;
            font-weight: 800;
            line-height: 1;
        }

        .tv-progress {
            position: relative;
            background: #F1F5F9;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .tv-progress-bar {
            height: 100%;
            border-radius: 3px;
        }

        .tv-progress-text {
            position: absolute;
            top: -16px;
            right: 0;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* === RIGHT COLUMN: 2 CHARTS === */
        .charts-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chart-section {
            flex: 1;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.08);
            border: 1px solid #F1F5F9;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-title.ldm {
            color: var(--accent-green);
        }

        .chart-title.tdh {
            color: var(--accent-blue);
        }

        .chart-container {
            flex: 1;
            position: relative;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #E2E8F0;
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 0.5rem 3rem;
            font-size: 14px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            z-index: 50;
        }
    </style>
</head>

<body>
    <!-- Loading -->
    <div id="loading" class="loading-overlay active">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: var(--text-secondary); font-size: 18px;">
            Đang tải dữ liệu...</p>
    </div>

    <!-- Header -->
    <header>
        <div class="brand-container">
            <div class="brand-logo">N</div>
            <div class="brand-text">
                <h1>TIẾN ĐỘ THI CÔNG & LẮP ĐẶT</h1>
                <p>Dashboard Giám Sát Điều Hành</p>
            </div>
        </div>
        <div class="clock-container">
            <div class="time" id="clock-time">--:--</div>
            <div class="date" id="clock-date">...</div>
        </div>
    </header>

    <!-- Main 2-Column Layout -->
    <main>
        <!-- Left: Info Cards Grid -->
        <div class="info-section">
            <div class="section-header">
                <h2 class="section-title">Thông Tin Công Việc</h2>
            </div>
            <div class="cards-grid" id="cards-grid">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- Right: 2 Charts -->
        <div class="charts-column">
            <!-- Chart 1: Lắp Đặt Mới -->
            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title ldm">Lắp Đặt Mới (LĐM)</h2>
                </div>
                <div class="chart-container">
                    <canvas id="ldmChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Thay Đồng Hồ -->
            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title tdh">Thay Đồng Hồ (TĐH)</h2>
                </div>
                <div class="chart-container">
                    <canvas id="tdhChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="api-status">API: Connecting...</span>
        <span id="last-update">Last Update: --:--:--</span>
    </div>

    <script>
        // CONFIG
        const API_URL = 'http://localhost:44311/api/services/app/Report/GetReportDataNoCount';
        const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjQ0MiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJuc3RhbmgiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJuc3RhbmhAbmF3YXNjby5jb20udm4iLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6IlJNRFdIVExXTU1LUzdZNElGM1FMVlEyRUU2Q1ZRNjJRIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIkFkbWluIiwixJDEg25nIGvDvSBuZ2jhu4kiXSwic3ViIjoiNDQyIiwianRpIjoiOWJlYmU0NzMtMmM5OC00NTczLTk2OGYtMzlmZjRmY2IzYTdkIiwiaWF0IjoxNzM3NTUyMTI5LCJuYmYiOjE3Mzc1NTIxMjksImV4cCI6MjA1MjkxMjEyOSwiaXNzIjoiRVJQIiwiYXVkIjoiRVJQIn0.i5NWUse89skdwOKFXnaBAYJA-JQBkNDYyO5ucfbVHi4';
        const PAYLOAD = {
            "reportPath": "tt.dktt_ThongKeLapDatMoiAndThayThe",
            "page": 0,
            "format": "HTML",
            "parameters": {}
        };

        // DOM
        const cardsGrid = document.getElementById('cards-grid');
        const loadingOverlay = document.getElementById('loading');
        const apiStatus = document.getElementById('api-status');
        const lastUpdate = document.getElementById('last-update');

        // CLOCK
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').textContent = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').textContent = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // CREATE CARD HTML
        function createCardHTML(item) {
            const total = item.ChuaHoanThanh + item.DaHoanThanh;
            const percent = total > 0 ? Math.round((item.DaHoanThanh / total) * 100) : 0;
            const accentColor = item.LoaiDK === 'LĐM' ? 'var(--accent-green)' : 'var(--accent-blue)';

            return `
                <div class="tv-card" style="border-left: 5px solid ${accentColor}">
                    <div class="tv-card-header">
                        <h3 class="tv-card-title">${item.NoiDung}</h3>
                        <span class="tv-card-badge">${item.LoaiDK}</span>
                    </div>
                    
                    <div class="tv-metrics">
                        <div class="tv-metric">
                            <div class="tv-metric-label">Chờ xử lý</div>
                            <div class="tv-metric-value" style="color: var(--accent-orange)">
                                ${item.ChuaHoanThanh.toLocaleString('vi-VN')}
                            </div>
                        </div>
                        
                        <div class="tv-metric">
                            <div class="tv-metric-label">Đã xong</div>
                            <div class="tv-metric-value" style="color: var(--accent-green)">
                                ${item.DaHoanThanh.toLocaleString('vi-VN')}
                            </div>
                        </div>
                        
                        <div class="tv-metric">
                            <div class="tv-metric-label">Lũy kế</div>
                            <div class="tv-metric-value" style="color: var(--accent-blue)">
                                ${item.LuyKeDaHoanThanh.toLocaleString('vi-VN')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="tv-progress">
                        <span class="tv-progress-text">${percent}%</span>
                        <div class="tv-progress-bar" style="width: ${percent}%; background: ${accentColor}"></div>
                    </div>
                </div>
            `;
        }

        // RENDER CARDS
        function renderCards(items) {
            const sortedItems = items.sort((a, b) => a.TT - b.TT);
            cardsGrid.innerHTML = sortedItems.map(item => createCardHTML(item)).join('');
        }

        // INIT CHARTS
        let ldmChart = null;
        let tdhChart = null;

        function createChartConfig(color, title) {
            return {
                type: 'bar',
                data: {
                    labels: ['XNDV', '10 Trạm', 'BGK'],
                    datasets: [
                        {
                            label: 'Chờ xử lý',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(245, 158, 11, 0.85)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Đã xong',
                            data: [0, 0, 0],
                            backgroundColor: color === 'green' ? 'rgba(16, 185, 129, 0.85)' : 'rgba(59, 130, 246, 0.85)',
                            borderColor: color === 'green' ? 'rgba(16, 185, 129, 1)' : 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Lũy kế',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(139, 92, 246, 0.85)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' },
                                padding: 10,
                                boxWidth: 12,
                                boxHeight: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            offset: 2,
                            font: { family: 'Plus Jakarta Sans', size: 10, weight: '700' },
                            color: '#0F172A',
                            formatter: function (value) {
                                return value > 0 ? value.toLocaleString('vi-VN') : '';
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' }, color: '#64748B' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(226, 232, 240, 0.6)', drawBorder: false },
                            ticks: {
                                font: { family: 'Plus Jakarta Sans', size: 10 },
                                color: '#64748B',
                                callback: function (value) { return value.toLocaleString('vi-VN'); }
                            }
                        }
                    },
                    animation: { duration: 600, easing: 'easeOutQuart' }
                }
            };
        }

        function initCharts() {
            const ldmCtx = document.getElementById('ldmChart').getContext('2d');
            const tdhCtx = document.getElementById('tdhChart').getContext('2d');

            ldmChart = new Chart(ldmCtx, createChartConfig('green', 'LĐM'));
            tdhChart = new Chart(tdhCtx, createChartConfig('blue', 'TĐH'));
        }

        // UPDATE CHARTS
        function updateCharts(items) {
            if (!ldmChart || !tdhChart) return;

            const ldmItems = items.filter(i => i.LoaiDK === 'LĐM');
            const tdhItems = items.filter(i => i.LoaiDK === 'TĐH');

            // Helper to find item by NoiDung
            const findData = (arr, name) => {
                const item = arr.find(i => i.NoiDung && i.NoiDung.includes(name));
                return item ? [item.ChuaHoanThanh, item.DaHoanThanh, item.LuyKeDaHoanThanh] : [0, 0, 0];
            };

            // LĐM data
            const ldmXNDV = findData(ldmItems, 'XNDV');
            const ldmTram = findData(ldmItems, '10 Trạm');
            const ldmBGK = findData(ldmItems, 'BGK');

            ldmChart.data.datasets[0].data = [ldmXNDV[0], ldmTram[0], ldmBGK[0]]; // Chờ xử lý
            ldmChart.data.datasets[1].data = [ldmXNDV[1], ldmTram[1], ldmBGK[1]]; // Đã xong
            ldmChart.data.datasets[2].data = [ldmXNDV[2], ldmTram[2], ldmBGK[2]]; // Lũy kế
            ldmChart.update();

            // TĐH data
            const tdhXNDV = findData(tdhItems, 'XNDV');
            const tdhTram = findData(tdhItems, '10 Trạm');
            const tdhBGK = findData(tdhItems, 'BGK');

            tdhChart.data.datasets[0].data = [tdhXNDV[0], tdhTram[0], tdhBGK[0]]; // Chờ xử lý
            tdhChart.data.datasets[1].data = [tdhXNDV[1], tdhTram[1], tdhBGK[1]]; // Đã xong
            tdhChart.data.datasets[2].data = [tdhXNDV[2], tdhTram[2], tdhBGK[2]]; // Lũy kế
            tdhChart.update();
        }

        // FETCH DATA
        async function fetchData() {
            try {
                if (cardsGrid.children.length === 0) loadingOverlay.classList.add('active');

                apiStatus.textContent = 'API: Fetching...';

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'accept': 'text/plain',
                        'Content-Type': 'application/json',
                        'Authorization': AUTH_TOKEN
                    },
                    body: JSON.stringify(PAYLOAD)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                if (data.success && data.result?.items) {
                    renderCards(data.result.items);
                    updateCharts(data.result.items);
                    apiStatus.textContent = 'API: Connected ✅';
                    apiStatus.style.color = 'var(--accent-green)';
                } else {
                    throw new Error('Invalid Data Format');
                }

            } catch (err) {
                console.error(err);
                apiStatus.textContent = `API Error: ${err.message} ⚠️`;
                apiStatus.style.color = 'var(--accent-orange)';

                if (cardsGrid.children.length === 0) {
                    cardsGrid.innerHTML = `<div style="color:red; padding:1.5rem; font-size: 18px; grid-column: 1/-1;">Không thể tải dữ liệu. Kiểm tra kết nối API.</div>`;
                }
            } finally {
                loadingOverlay.classList.remove('active');
                lastUpdate.textContent = `Last Update: ${new Date().toLocaleTimeString('vi-VN')}`;
            }
        }

        // INIT
        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            fetchData();
            setInterval(fetchData, 30000); // Refresh every 30s
        });
    </script>
</body>

</html>