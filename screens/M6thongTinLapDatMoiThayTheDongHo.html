<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Dashboard - Lắp Đặt Mới & Thay Đồng Hồ</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root {
            /* Colors */
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            --accent-blue: #3B82F6;
            --accent-green: #10B981;
            --accent-orange: #F59E0B;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 10vh 90vh;
        }

        /* === HEADER === */
        header {
            padding: 0 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border-bottom: 2px solid #E2E8F0;
        }

        .brand-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo {
            width: 56px;
            height: 56px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 2rem;
        }

        .brand-text h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-text p {
            font-size: 18px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .clock-container {
            text-align: right;
            background: #F1F5F9;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
        }

        .time {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-blue);
            font-variant-numeric: tabular-nums;
        }

        .date {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* === MAIN 2-COLUMN LAYOUT === */
        main {
            display: grid;
            grid-template-columns: 50fr 50fr;
            gap: 1rem;
            padding: 1rem 2rem;
            height: 100%;
        }

        /* === LEFT COLUMN: INFO CARDS GRID === */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-header::before {
            content: '';
            width: 5px;
            height: 28px;
            background: var(--primary-gradient);
            border-radius: 3px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Data Table */
        .data-table-container {
            flex: 1;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.08);
            border: 1px solid #F1F5F9;
            overflow: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid #E2E8F0;
        }

        .data-table thead th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 700;
            font-size: 15px;
            white-space: nowrap;
        }

        .data-table tbody td {
            background: var(--card-bg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-table tbody tr:nth-child(even) td {
            background: #F8FAFC;
        }

        .data-table tbody td.loai-dk {
            font-weight: 700;
            color: var(--accent-blue);
            background: #EFF6FF;
        }

        .data-table tbody td.loai-dk.ldm {
            color: var(--accent-green);
            background: #ECFDF5;
        }

        .data-table tbody td.number {
            font-variant-numeric: tabular-nums;
        }

        .data-table tbody td.chua-ht {
            color: var(--accent-orange);
        }

        .data-table tbody td.da-ht {
            color: var(--accent-green);
        }

        .data-table tbody td.luỹ-ke {
            color: var(--accent-blue);
        }

        .data-table tbody td.huy {
            color: #EF4444;
        }

        .table-note {
            margin-top: 0.75rem;
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* === RIGHT COLUMN: 2 CHARTS === */
        .charts-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chart-section {
            flex: 1;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.08);
            border: 1px solid #F1F5F9;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-title.ldm {
            color: var(--accent-green);
        }

        .chart-title.tdh {
            color: var(--accent-blue);
        }

        .chart-container {
            flex: 1;
            position: relative;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #E2E8F0;
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 0.5rem 3rem;
            font-size: 14px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            z-index: 50;
        }
    </style>
</head>

<body>
    <!-- Loading -->
    <div id="loading" class="loading-overlay active">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: var(--text-secondary); font-size: 18px;">
            Đang tải dữ liệu...</p>
    </div>

    <!-- Header -->
    <header>
        <div class="brand-container">
            <div class="brand-logo">N</div>
            <div class="brand-text">
                <h1>TIẾN ĐỘ THI CÔNG & LẮP ĐẶT</h1>
                <p>Dashboard Giám Sát Điều Hành</p>
            </div>
        </div>
        <div class="clock-container">
            <div class="time" id="clock-time">--:--</div>
            <div class="date" id="clock-date">...</div>
        </div>
    </header>

    <!-- Main 2-Column Layout -->
    <main>
        <!-- Left: Info Cards Grid -->
        <div class="info-section">
            <div class="section-header">
                <h2 class="section-title">Thông Tin Công Việc</h2>
            </div>
            <div class="data-table-container">
                <table class="data-table" id="data-table">
                    <thead>
                        <tr>
                            <th>TT</th>
                            <th>Loại ĐK</th>
                            <th>Nội dung</th>
                            <th>Chưa hoàn thành</th>
                            <th>Đã hoàn thành</th>
                            <th>Lũy kế đã hoàn thành</th>
                            <th>Hủy</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Table rows will be injected here -->
                    </tbody>
                </table>
                <p class="table-note">Lưu ý phần mềm: Số lượng đã hoàn thành, hủy được tính trong tháng, số lượng lũy kế
                    đã hoàn thành được tính từ đầu năm.</p>
            </div>
        </div>

        <!-- Right: 2 Charts -->
        <div class="charts-column">
            <!-- Chart 1: Lắp Đặt Mới -->
            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title ldm">Lắp Đặt Mới (LĐM)</h2>
                </div>
                <div class="chart-container">
                    <canvas id="ldmChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Thay Đồng Hồ -->
            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title tdh">Thay Đồng Hồ (TĐH)</h2>
                </div>
                <div class="chart-container">
                    <canvas id="tdhChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="api-status">API: Connecting...</span>
        <span id="last-update">Last Update: --:--:--</span>
    </div>

    <script>
        // Register ChartDataLabels plugin
        Chart.register(ChartDataLabels);

        // CONFIG
        const API_URL = 'https://unsupercilious-leonarda-unreaving.ngrok-free.dev/api/services/app/Report/GetReportDataNoCount';
        const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjQ0MiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJuc3RhbmgiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJuc3RhbmhAbmF3YXNjby5jb20udm4iLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6IlJNRFdIVExXTU1LUzdZNElGM1FMVlEyRUU2Q1ZRNjJRIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIkFkbWluIiwixJDEg25nIGvDvSBuZ2jhu4kiXSwic3ViIjoiNDQyIiwianRpIjoiOWJlYmU0NzMtMmM5OC00NTczLTk2OGYtMzlmZjRmY2IzYTdkIiwiaWF0IjoxNzM3NTUyMTI5LCJuYmYiOjE3Mzc1NTIxMjksImV4cCI6MjA1MjkxMjEyOSwiaXNzIjoiRVJQIiwiYXVkIjoiRVJQIn0.i5NWUse89skdwOKFXnaBAYJA-JQBkNDYyO5ucfbVHi4';

        // Tính toán ngày: từ ngày 1 của tháng đến ngày hiện tại
        function getDateParameters() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            // Từ ngày: ngày 1 của tháng hiện tại
            const tuNgay = `${year}-${month}-01`;
            // Đến ngày: ngày hiện tại
            const denNgay = `${year}-${month}-${day}`;

            return { tuNgay, denNgay };
        }

        const { tuNgay, denNgay } = getDateParameters();

        const PAYLOAD = {
            "reportPath": "tt.dktt_ThongKeLapDatMoiAndThayThe",
            "page": 0,
            "format": "HTML",
            "parameters": {
                "TUNGAY": tuNgay,
                "DENNGAY": denNgay
            }
        };

        // DOM
        const tableBody = document.getElementById('table-body');
        const loadingOverlay = document.getElementById('loading');
        const apiStatus = document.getElementById('api-status');
        const lastUpdate = document.getElementById('last-update');

        // CLOCK
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').textContent = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').textContent = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // RENDER TABLE - with merged LoaiDK cells
        function renderTable(items) {
            const sortedItems = items.sort((a, b) => a.TT - b.TT);

            // Group items by LoaiDK to calculate rowspan
            const groups = {};
            sortedItems.forEach(item => {
                if (!groups[item.LoaiDK]) {
                    groups[item.LoaiDK] = [];
                }
                groups[item.LoaiDK].push(item);
            });

            let html = '';
            let processedLoaiDK = {};

            sortedItems.forEach(item => {
                const isFirstInGroup = !processedLoaiDK[item.LoaiDK];
                const rowspan = groups[item.LoaiDK].length;
                const isLDM = item.LoaiDK === 'LĐM';

                html += `<tr>
                    <td class="number">${item.TT}</td>
                    ${isFirstInGroup ? `<td class="loai-dk ${isLDM ? 'ldm' : ''}" rowspan="${rowspan}">${item.LoaiDK}</td>` : ''}
                    <td>${item.NoiDung}</td>
                    <td class="number chua-ht">${item.ChuaHoanThanh.toLocaleString('vi-VN')}</td>
                    <td class="number da-ht">${item.DaHoanThanh.toLocaleString('vi-VN')}</td>
                    <td class="number luỹ-ke">${item.LuyKeDaHoanThanh.toLocaleString('vi-VN')}</td>
                    <td class="number huy">${item.Huy}</td>
                </tr>`;

                if (isFirstInGroup) {
                    processedLoaiDK[item.LoaiDK] = true;
                }
            });

            tableBody.innerHTML = html;
        }

        // INIT CHARTS
        let ldmChart = null;
        let tdhChart = null;

        // Chart config for LĐM (chỉ có XNDV, 10 Trạm)
        function createLdmChartConfig() {
            return {
                type: 'bar',
                data: {
                    labels: ['XNDV', '10 Trạm'],
                    datasets: [
                        {
                            label: 'Chưa hoàn thành',
                            data: [0, 0],
                            backgroundColor: 'rgba(245, 158, 11, 0.85)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Đã hoàn thành',
                            data: [0, 0],
                            backgroundColor: 'rgba(16, 185, 129, 0.85)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Lũy kế đã HT',
                            data: [0, 0],
                            backgroundColor: 'rgba(139, 92, 246, 0.85)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' },
                                padding: 10,
                                boxWidth: 12,
                                boxHeight: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            font: { family: 'Plus Jakarta Sans', size: 12, weight: '700' },
                            color: '#0F172A',
                            formatter: function (value) {
                                return value.toLocaleString('vi-VN');
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' }, color: '#64748B' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(226, 232, 240, 0.6)', drawBorder: false },
                            ticks: {
                                font: { family: 'Plus Jakarta Sans', size: 10 },
                                color: '#64748B',
                                callback: function (value) { return value.toLocaleString('vi-VN'); }
                            }
                        }
                    },
                    animation: { duration: 600, easing: 'easeOutQuart' }
                }
            };
        }

        // Chart config for TĐH (có XNDV, 10 Trạm, BGK)
        function createTdhChartConfig() {
            return {
                type: 'bar',
                data: {
                    labels: ['XNDV', '10 Trạm', 'BGK'],
                    datasets: [
                        {
                            label: 'Chưa hoàn thành',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(245, 158, 11, 0.85)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Đã hoàn thành',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(59, 130, 246, 0.85)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Lũy kế đã HT',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(139, 92, 246, 0.85)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' },
                                padding: 10,
                                boxWidth: 12,
                                boxHeight: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            font: { family: 'Plus Jakarta Sans', size: 12, weight: '700' },
                            color: '#0F172A',
                            formatter: function (value) {
                                return value.toLocaleString('vi-VN');
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' }, color: '#64748B' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(226, 232, 240, 0.6)', drawBorder: false },
                            ticks: {
                                font: { family: 'Plus Jakarta Sans', size: 10 },
                                color: '#64748B',
                                callback: function (value) { return value.toLocaleString('vi-VN'); }
                            }
                        }
                    },
                    animation: { duration: 600, easing: 'easeOutQuart' }
                }
            };
        }

        function initCharts() {
            const ldmCtx = document.getElementById('ldmChart').getContext('2d');
            const tdhCtx = document.getElementById('tdhChart').getContext('2d');

            ldmChart = new Chart(ldmCtx, createLdmChartConfig());
            tdhChart = new Chart(tdhCtx, createTdhChartConfig());
        }

        // UPDATE CHARTS
        function updateCharts(items) {
            if (!ldmChart || !tdhChart) return;

            const ldmItems = items.filter(i => i.LoaiDK === 'LĐM');
            const tdhItems = items.filter(i => i.LoaiDK === 'TĐH');

            // Helper to find item by NoiDung
            const findData = (arr, name) => {
                const item = arr.find(i => i.NoiDung && i.NoiDung.includes(name));
                return item ? [item.ChuaHoanThanh, item.DaHoanThanh, item.LuyKeDaHoanThanh] : [0, 0, 0];
            };

            // LĐM data (chỉ có XNDV, 10 Trạm)
            const ldmXNDV = findData(ldmItems, 'XNDV');
            const ldmTram = findData(ldmItems, '10 Trạm');

            ldmChart.data.datasets[0].data = [ldmXNDV[0], ldmTram[0]]; // Chưa hoàn thành
            ldmChart.data.datasets[1].data = [ldmXNDV[1], ldmTram[1]]; // Đã hoàn thành
            ldmChart.data.datasets[2].data = [ldmXNDV[2], ldmTram[2]]; // Lũy kế đã HT
            ldmChart.update();

            // TĐH data (có XNDV, 10 Trạm, BGK)
            const tdhXNDV = findData(tdhItems, 'XNDV');
            const tdhTram = findData(tdhItems, '10 Trạm');
            const tdhBGK = findData(tdhItems, 'BGK');

            tdhChart.data.datasets[0].data = [tdhXNDV[0], tdhTram[0], tdhBGK[0]]; // Chưa hoàn thành
            tdhChart.data.datasets[1].data = [tdhXNDV[1], tdhTram[1], tdhBGK[1]]; // Đã hoàn thành
            tdhChart.data.datasets[2].data = [tdhXNDV[2], tdhTram[2], tdhBGK[2]]; // Lũy kế đã HT
            tdhChart.update();
        }

        // FETCH DATA
        async function fetchData() {
            try {
                if (tableBody.children.length === 0) loadingOverlay.classList.add('active');

                apiStatus.textContent = 'API: Fetching...';

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'accept': 'text/plain',
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true',
                        'Authorization': AUTH_TOKEN
                    },
                    body: JSON.stringify(PAYLOAD)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                if (data.success && data.result?.items) {
                    renderTable(data.result.items);
                    updateCharts(data.result.items);
                    apiStatus.textContent = 'API: Connected ✅';
                    apiStatus.style.color = 'var(--accent-green)';
                } else {
                    throw new Error('Invalid Data Format');
                }

            } catch (err) {
                console.error(err);
                apiStatus.textContent = `API Error: ${err.message} ⚠️`;
                apiStatus.style.color = 'var(--accent-orange)';

                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="color:red; padding:1.5rem; font-size: 18px;">Không thể tải dữ liệu. Kiểm tra kết nối API.</td></tr>`;
                }
            } finally {
                loadingOverlay.classList.remove('active');
                lastUpdate.textContent = `Last Update: ${new Date().toLocaleTimeString('vi-VN')}`;
            }
        }

        // INIT
        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            fetchData();
            setInterval(fetchData, 30000); // Refresh every 30s
        });
    </script>
</body>

</html>