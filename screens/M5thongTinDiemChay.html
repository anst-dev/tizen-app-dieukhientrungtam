<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard - Giám Sát Điểm Chảy</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3B82F6",
                        secondary: "#93C5FD",
                        "background-light": "#F8FAFC",
                        "background-dark": "#020617",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#0F172A",
                        "text-light": "#0F172A",
                        "text-dark": "#F8FAFC",
                        "accent-success": "#10B981",
                        "accent-warning": "#F59E0B",
                        "accent-danger": "#EF4444",
                        "accent-purple": "#8b5cf6",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    }
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .tv-scrollbar::-webkit-scrollbar {
            width: 12px;
        }

        .tv-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .tv-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
            border: 4px solid transparent;
            background-clip: content-box;
        }

        @keyframes pulse-focus {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: #60A5FA;
            }

            50% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
                border-color: #3B82F6;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: #60A5FA;
            }
        }

        .focused {
            animation: pulse-focus 2s infinite;
            border: 2px solid #3B82F6 !important;
            background-color: #EFF6FF !important;
            transform: scale(1.02);
            z-index: 20;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #E2E8F0;
            border-top-color: #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .badge-overdue {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>

<body class="bg-background-light text-text-light h-screen w-screen flex items-center justify-center">
    <div id="loading" class="loading-overlay active">
        <div class="spinner"></div>
        <p class="mt-4 font-semibold text-slate-500 text-lg">Đang tải dữ liệu...</p>
    </div>

    <!-- Modal Structure -->
    <div id="all-modal" class="fixed inset-0 z-[1000] hidden items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white border border-blue-500 rounded-3xl w-[90%] h-[90%] flex flex-col shadow-2xl p-8 relative overflow-hidden">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h2 class="text-3xl font-extrabold text-slate-900 flex items-center gap-3">
                    <span class="material-symbols-outlined text-4xl text-blue-600">list_alt</span>
                    Tất Cả Điểm Chảy Chưa Hoàn Thành
                </h2>
                <span class="text-slate-400 font-medium">Nhấn [Back] hoặc [ESC] để đóng</span>
            </div>
            <div class="flex-grow overflow-y-auto tv-scrollbar">
                <table id="all-table" class="w-full text-left border-separate border-spacing-y-2">
                    <thead class="sticky top-0 z-10 bg-white shadow-sm">
                        <tr class="text-sm uppercase tracking-wider text-slate-400 font-bold">
                            <th class="px-4 py-3">Mã ĐC</th>
                            <th class="px-4 py-3">Vị Trí</th>
                            <th class="px-4 py-3">Số Điện Thoại</th>
                            <th class="px-4 py-3">Ngày Tiếp Nhận</th>
                            <th class="px-4 py-3">Thời gian (Phút)</th>
                            <th class="px-4 py-3">Trạng Thái</th>
                        </tr>
                    </thead>
                    <tbody id="all-body" class="text-lg">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="w-[97vw] h-[97vh] flex flex-col gap-6 relative">
        <header class="flex-shrink-0 flex items-center justify-between px-2 pb-2">
            <div class="flex items-center gap-6">
                <div class="h-16 w-16 rounded-2xl bg-blue-600 flex items-center justify-center text-white shadow-xl shadow-blue-500/20">
                    <span class="material-symbols-outlined text-4xl">water_damage</span>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight leading-tight">
                        Thông tin điểm chảy
                    </h1>
                    <button id="btn-view-all" class="mt-1 focusable px-4 py-1.5 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg font-bold text-sm transition-all hover:bg-blue-600 hover:text-white" onclick="openModal()">
                        Xem Tất Cả
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-6 text-right">
                <div>
                    <div id="clock-time" class="text-4xl font-black text-slate-900">--:--</div>
                    <div id="clock-date" class="text-base font-medium text-slate-500">...</div>
                </div>
            </div>
        </header>

        <main class="flex-grow grid grid-cols-10 gap-6 overflow-hidden h-full">
            <!-- Left Column: Stats -->
            <div class="col-span-2 flex flex-col gap-4 h-full">
                <div class="flex-1 bg-white rounded-3xl p-5 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider">Tổng Điểm Chảy Tháng</p>
                    <p class="text-5xl font-black text-slate-900 mt-2" id="val-total">--</p>
                </div>
                <div class="flex-1 bg-white rounded-3xl p-5 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider">Đã Xử Lý</p>
                    <p class="text-5xl font-black text-accent-success mt-2" id="val-done">--</p>
                </div>
                <div class="flex-1 bg-white rounded-3xl p-5 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider">Đang Xử Lý</p>
                    <p class="text-5xl font-black text-accent-warning mt-2" id="val-pending">--</p>
                </div>
                <div class="flex-1 bg-white rounded-3xl p-5 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider">Nghe Dò (Vị Trí)</p>
                    <p class="text-5xl font-black text-accent-purple mt-2" id="val-listening-loc">--</p>
                </div>
            </div>

            <!-- Middle/Right Content -->
            <div class="col-span-8 flex flex-col gap-6 h-full overflow-hidden">
                <!-- Top row: Charts -->
                <div class="grid grid-cols-2 gap-6 h-[45%]">
                    <div class="bg-white rounded-3xl p-5 shadow-lg border border-slate-100 flex flex-col">
                        <h3 class="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-600">bar_chart</span>
                            Tình Hình Xử Lý
                        </h3>
                        <div class="flex-grow relative min-h-0">
                            <canvas id="processChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl p-5 shadow-lg border border-slate-100 flex flex-col">
                        <h3 class="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-600">query_stats</span>
                            Hoạt Động Nghe Dò
                        </h3>
                        <div class="flex-grow relative min-h-0">
                            <canvas id="listeningChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom row: Table -->
                <div class="flex-grow bg-white rounded-3xl shadow-lg border border-slate-100 flex flex-col overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-50 flex items-center justify-between bg-slate-50/50">
                        <h2 class="text-2xl font-black text-slate-900 flex items-center gap-3">
                            <span class="material-symbols-outlined text-red-500">warning</span>
                            Top 5 Chờ Xử Lý Lâu Nhất
                        </h2>
                        <span class="text-sm font-bold text-slate-400">Ưu tiên xử lý ngay</span>
                    </div>
                    <div class="flex-grow overflow-y-auto tv-scrollbar p-2">
                        <table class="w-full text-left border-separate border-spacing-y-1">
                            <thead>
                                <tr class="text-xs uppercase tracking-wider text-slate-400 font-bold">
                                    <th class="px-4 py-2">Mã ĐC</th>
                                    <th class="px-4 py-2">Vị Trí</th>
                                    <th class="px-4 py-2">Ngày Tiếp Nhận</th>
                                    <th class="px-4 py-2 text-right">Quá hạn (Phút)</th>
                                    <th class="px-4 py-2 text-center">Trạng Thái</th>
                                </tr>
                            </thead>
                            <tbody id="top5-body" class="text-lg">
                                <!-- Rendered via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONSTANTS ---
        const API_BASE = 'http://localhost:44311/api/services/app/Report/GetReportDataNoCount';
        const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjQ0MiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJuc3RhbmgiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJuc3RhbmhAbmF3YXNjby5jb20udm4iLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6IlJNRFdIVExXTU1LUzdZNElGM1FMVlEyRUU2Q1ZRNjJRIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIkFkbWluIiwixJDEg25nIGvDvSBuZ2jhu4kiXSwic3ViIjoiNDQyIiwianRpIjoiOWJlYmU0NzMtMmM5OC00NTczLTk2OGYtMzlmZjRmY2IzYTdkIiwiaWF0IjoxNzM3NTUyMTI5LCJuYmYiOjE3Mzc1NTIxMjksImV4cCI6MjA1MjkxMjEyOSwiaXNzIjoiRVJQIiwiYXVkIjoiRVJQIn0.i5NWUse89skdwOKFXnaBAYJA-JQBkNDYyO5ucfbVHi4';
        const XSRF_TOKEN = 'CfDJ8Jj_fLMZXdVGiF7LaxJKgH67zIadLPmx1rQUBmngplHfSzqmbvtWTw6wRiTBlIDSLmpo1XHvWPM0an_N6ktkr8iNrRtYQAqWPvfHKMhityf02HYc46dwr46xGnnRjVT_Qad-BzC-MxYcOeazYY9iP44swyLUZg6AJ6TjBiiYt7mjKgu8QoRHgIciWuKMrH8V1Q';

        // --- GLOBAL STATE ---
        let charts = {};
        let allLeakPoints = [];
        let isModalOpen = false;

        // --- CLOCK ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').innerText = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- API HELPER ---
        async function fetchReport(reportPath) {
            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'accept': 'text/plain',
                        'Content-Type': 'application/json',
                        'Authorization': AUTH_TOKEN,
                        'X-XSRF-TOKEN': XSRF_TOKEN
                    },
                    body: JSON.stringify({
                        reportPath: reportPath,
                        page: 0,
                        format: 'HTML',
                        parameters: {}
                    })
                });

                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                return data?.result?.items || [];
            } catch (e) {
                console.error("Fetch Error:", e);
                return [];
            }
        }

        // --- DATA PROCESSING ---
        async function reloadData() {
            document.getElementById('loading').classList.add('active');

            const [summaryData, detailData] = await Promise.all([
                fetchReport('tt.dktt_TongHopDiemChays'),
                fetchReport('tt.dktt_TongHopDiemChayChuaHoanThanhs')
            ]);

            const summary = summaryData[0] || {
                SoLuongDiemChayTrongThang: 0,
                SoLuongDaXuLy: 0,
                SoLuongDangXuLy: 0,
                SoLuongNgheDoTrongThang: 0,
                SoLuongViTriDangNgheDo: 0
            };

            const total = summary.SoLuongDiemChayTrongThang || 0;
            const done = summary.SoLuongDaXuLy || 0;
            const pending = summary.SoLuongDangXuLy || 0;
            const listeningCount = summary.SoLuongNgheDoTrongThang || 0;
            const listeningLocs = summary.SoLuongViTriDangNgheDo || 0;

            const validDetails = detailData.filter(i => i.MaDiemChay);
            validDetails.sort((a, b) => new Date(a.ThoiGianTiepNhan) - new Date(b.ThoiGianTiepNhan));
            allLeakPoints = validDetails;
            const top5 = validDetails.slice(0, 5);

            // Update UI
            document.getElementById('val-total').innerText = total;
            document.getElementById('val-done').innerText = done;
            document.getElementById('val-pending').innerText = pending;
            document.getElementById('val-listening-loc').innerText = listeningLocs;

            updateCharts(total, done, pending, listeningCount, listeningLocs);

            const tbody = document.getElementById('top5-body');
            tbody.innerHTML = '';
            top5.forEach(item => {
                tbody.appendChild(createRow(item, false));
            });

            if (isModalOpen) renderModalRows();
            document.getElementById('loading').classList.remove('active');
        }

        function createRow(item, isModal) {
            const tr = document.createElement('tr');
            tr.className = "group transition-all duration-200 hover:bg-blue-50/50";
            const isOverdue = item.QuaHanKhaoSat === 1;
            const receivedDate = new Date(item.ThoiGianTiepNhan);
            const minutes = item.KhoangThoiGianKhaoSat_Phut || 0;
            const formattedMin = new Intl.NumberFormat('vi-VN').format(minutes);

            const bgCell = "bg-slate-50/50 group-hover:bg-transparent transition-colors";

            if (!isModal) {
                tr.innerHTML = `
                    <td class="px-4 py-3 font-bold text-slate-900 rounded-l-xl ${bgCell}">${item.MaDiemChay}</td>
                    <td class="${bgCell}"><div class="truncate max-w-[20vw]" title="${item.ViTri}">${item.ViTri}</div></td>
                    <td class="${bgCell} text-slate-500 font-medium">${receivedDate.toLocaleDateString('vi-VN')}</td>
                    <td class="${bgCell} text-right font-bold ${minutes > 4320 ? 'text-accent-danger' : 'text-slate-600'}">${formattedMin}</td>
                    <td class="px-4 py-3 text-center rounded-r-xl ${bgCell}">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${isOverdue ? 'bg-red-100 text-red-600 badge-overdue' : 'bg-amber-100 text-amber-600'}">
                            ${isOverdue ? 'QUÁ HẠN' : 'Đang xử lý'}
                        </span>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td class="px-4 py-3 font-bold text-slate-900 rounded-l-xl ${bgCell}">${item.MaDiemChay}</td>
                    <td class="${bgCell}"><div class="truncate max-w-[25vw]" title="${item.ViTri}">${item.ViTri}</div></td>
                    <td class="${bgCell}">${item.SoDienThoai || ''}</td>
                    <td class="${bgCell} text-slate-500 font-medium">${receivedDate.toLocaleDateString('vi-VN')}</td>
                    <td class="${bgCell} font-bold ${minutes > 4320 ? 'text-accent-danger' : 'text-slate-600'}">${formattedMin}</td>
                    <td class="px-4 py-3 rounded-r-xl ${bgCell}">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${isOverdue ? 'bg-red-100 text-red-600 badge-overdue' : 'bg-amber-100 text-amber-600'}">
                            ${isOverdue ? 'QUÁ HẠN' : 'Đang xử lý'}
                        </span>
                    </td>
                `;
            }
            return tr;
        }

        // --- CHARTS ---
        function updateCharts(total, done, pending, listeningCount, listeningLocs) {
            // Chart 1: Process Overview
            const ctxProcess = document.getElementById('processChart').getContext('2d');
            if (charts.process) charts.process.destroy();

            charts.process = new Chart(ctxProcess, {
                type: 'bar',
                data: {
                    labels: ['Đang xử lý', 'Đã xử lý', 'Tổng số'],
                    datasets: [{
                        data: [pending, done, total],
                        backgroundColor: ['#F59E0B', '#10B981', '#3B82F6'],
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { weight: 'bold' } } },
                        y: { grid: { display: false }, ticks: { color: '#1e293b', font: { size: 14, weight: 'bold' } } }
                    }
                }
            });

            // Chart 2: Listening stats
            const ctxListening = document.getElementById('listeningChart').getContext('2d');
            if (charts.listening) charts.listening.destroy();

            charts.listening = new Chart(ctxListening, {
                type: 'bar',
                data: {
                    labels: ['Số lần nghe dò', 'Vị trí đang nghe'],
                    datasets: [{
                        data: [listeningCount, listeningLocs],
                        backgroundColor: ['#8b5cf6', '#ec4899'],
                        borderRadius: 8,
                        barPercentage: 0.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#1e293b', font: { size: 14, weight: 'bold' } } }
                    }
                }
            });
        }

        // --- MODAL LOGIC ---
        function openModal() {
            isModalOpen = true;
            document.getElementById('all-modal').style.display = 'flex';
            renderModalRows();
        }

        function closeModal() {
            isModalOpen = false;
            document.getElementById('all-modal').style.display = 'none';
        }

        function renderModalRows() {
            const tbody = document.getElementById('all-body');
            tbody.innerHTML = '';
            allLeakPoints.forEach(item => {
                tbody.appendChild(createRow(item, true));
            });
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            reloadData();
            updateFocus();
        };
        setInterval(reloadData, 300000);

        // --- NAVIGATION & INPUT ---
        const focusableSelectors = '.focusable';
        let focusIndex = 0;

        function getFocusables() {
            return Array.from(document.querySelectorAll(focusableSelectors));
        }

        function updateFocus() {
            const els = getFocusables();
            if (els.length === 0) return;
            if (focusIndex < 0) focusIndex = els.length - 1;
            if (focusIndex >= els.length) focusIndex = 0;
            els.forEach(el => el.classList.remove('focused'));
            els[focusIndex].classList.add('focused');
            els[focusIndex].focus();
        }

        window.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' || e.keyCode === 10009 || e.key === 'Back') {
                if (isModalOpen) {
                    closeModal();
                    e.preventDefault();
                } else {
                    window.parent.postMessage({ type: 'back' }, '*');
                }
                return;
            }

            if (isModalOpen) {
                if (e.keyCode === 38) { // Up
                    document.querySelector('.modal-body').scrollBy({ top: -100, behavior: 'smooth' });
                }
                if (e.keyCode === 40) { // Down
                    document.querySelector('.modal-body').scrollBy({ top: 100, behavior: 'smooth' });
                }
            } else {
                const els = getFocusables();
                if (e.keyCode === 37) { // Left
                    focusIndex--;
                    updateFocus();
                } else if (e.keyCode === 39) { // Right
                    focusIndex++;
                    updateFocus();
                } else if (e.keyCode === 13) { // Enter
                    if (els[focusIndex]) els[focusIndex].click();
                }
            }
        });
    </script>
</body>

</html>
