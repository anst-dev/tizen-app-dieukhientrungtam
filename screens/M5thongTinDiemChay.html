<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard - Giám Sát Điểm Chảy</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3B82F6",
                        secondary: "#93C5FD",
                        "background-light": "#F8FAFC",
                        "background-dark": "#020617",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#0F172A",
                        "text-light": "#0F172A",
                        "text-dark": "#F8FAFC",
                        "accent-success": "#10B981",
                        "accent-warning": "#F59E0B",
                        "accent-danger": "#EF4444",
                        "accent-purple": "#8b5cf6",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    }
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .tv-scrollbar::-webkit-scrollbar {
            width: 12px;
        }

        .tv-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .tv-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
            border: 4px solid transparent;
            background-clip: content-box;
        }

        @keyframes pulse-focus {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: #60A5FA;
            }

            50% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
                border-color: #3B82F6;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: #60A5FA;
            }
        }

        .focused {
            animation: pulse-focus 2s infinite;
            border: 2px solid #3B82F6 !important;
            background-color: #EFF6FF !important;
            transform: scale(1.02);
            z-index: 20;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #E2E8F0;
            border-top-color: #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .badge-overdue {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>

<body class="bg-background-light text-text-light h-screen w-screen flex items-center justify-center">
    <div id="loading" class="loading-overlay active">
        <div class="spinner"></div>
        <p class="mt-4 font-semibold text-slate-500 text-lg">Đang tải dữ liệu...</p>
    </div>

    <!-- Modal đã bỏ theo yêu cầu -->

    <div class="w-[97vw] h-[97vh] flex flex-col gap-4 relative">
        <header class="flex-shrink-0 flex items-center justify-between px-2 pb-2">
            <div class="flex items-center gap-6">
                <div
                    class="h-16 w-16 rounded-2xl bg-blue-600 flex items-center justify-center text-white shadow-xl shadow-blue-500/20">
                    <span class="material-symbols-outlined text-4xl">water_damage</span>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight leading-tight">
                        Thông tin điểm chảy
                    </h1>
                </div>
            </div>
            <div class="flex items-center gap-6 text-right">
                <div>
                    <div id="clock-time" class="text-4xl font-black text-slate-900">--:--</div>
                    <div id="clock-date" class="text-base font-medium text-slate-500">...</div>
                </div>
            </div>
        </header>

        <main class="flex-grow grid grid-cols-10 gap-4 overflow-hidden h-full">
            <!-- Left Column: Stats -->
            <div class="col-span-2 flex flex-col gap-3 h-full">
                <div
                    class="flex-1 bg-white rounded-2xl p-4 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tổng Điểm Chảy Tháng</p>
                    <p class="text-4xl font-black text-slate-900 mt-1" id="val-total">--</p>
                </div>
                <div
                    class="flex-1 bg-white rounded-2xl p-4 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Đã nghiệm thu</p>
                    <p class="text-4xl font-black text-accent-success mt-1" id="val-done">--</p>
                </div>
                <div
                    class="flex-1 bg-white rounded-2xl p-4 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Chưa nghiệm thu</p>
                    <p class="text-4xl font-black text-accent-warning mt-1" id="val-pending">--</p>
                </div>
                <div
                    class="flex-1 bg-white rounded-2xl p-4 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">SL Nghe Dò trong tháng</p>
                    <p class="text-4xl font-black text-accent-purple mt-1" id="val-listening-count">--</p>
                </div>
                <div
                    class="flex-1 bg-white rounded-2xl p-4 shadow-lg border border-slate-100 flex flex-col justify-center">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">SL Điểm Đang Nghe Dò</p>
                    <p class="text-4xl font-black text-accent-purple mt-1" id="val-listening-loc">--</p>
                </div>
            </div>

            <!-- Right Column: 2 Tables -->
            <div class="col-span-8 flex flex-col gap-4 h-full overflow-hidden">


                <!-- Bottom Table: All Items -->
                <div
                    class="flex-grow bg-white rounded-2xl shadow-lg border border-slate-100 flex flex-col overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-50 flex items-center justify-between bg-slate-50/50">
                        <h2 class="text-xl font-black text-slate-900 flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-600">list_alt</span>
                            Tất Cả Điểm Chảy Chưa Hoàn Thành
                        </h2>
                        <span class="text-xs font-bold text-slate-400" id="all-count">Tổng: 0</span>
                    </div>
                    <div class="flex-grow overflow-y-auto tv-scrollbar p-2">
                        <table class="w-full text-left border-separate border-spacing-y-1">
                            <thead class="sticky top-0 z-10 bg-white">
                                <tr class="text-xs uppercase tracking-wider text-slate-400 font-bold">
                                    <th class="px-3 py-2 text-center">STT</th>
                                    <th class="px-3 py-2">Mã điểm chảy</th>
                                    <th class="px-3 py-2">Vị trí điểm chảy</th>
                                    <th class="px-3 py-2">Số điện thoại người báo tin</th>
                                    <th class="px-3 py-2">Thời gian tiếp nhận</th>
                                    <th class="px-3 py-2">Nhân viên kỹ thuật</th>
                                    <th class="px-3 py-2 text-center">Trạng thái xử lý</th>
                                </tr>
                            </thead>
                            <tbody id="all-body" class="text-sm">
                                <!-- Rendered via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONSTANTS ---
        const API_BASE = 'https://unsupercilious-leonarda-unreaving.ngrok-free.dev';
        const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjQ0MiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJuc3RhbmgiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJuc3RhbmhAbmF3YXNjby5jb20udm4iLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6IlJNRFdIVExXTU1LUzdZNElGM1FMVlEyRUU2Q1ZRNjJRIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIkFkbWluIiwixJDEg25nIGvDvSBuZ2jhu4kiXSwic3ViIjoiNDQyIiwianRpIjoiOWJlYmU0NzMtMmM5OC00NTczLTk2OGYtMzlmZjRmY2IzYTdkIiwiaWF0IjoxNzM3NTUyMTI5LCJuYmYiOjE3Mzc1NTIxMjksImV4cCI6MjA1MjkxMjEyOSwiaXNzIjoiRVJQIiwiYXVkIjoiRVJQIn0.i5NWUse89skdwOKFXnaBAYJA-JQBkNDYyO5ucfbVHi4';
        const XSRF_TOKEN = 'CfDJ8Jj_fLMZXdVGiF7LaxJKgH67zIadLPmx1rQUBmngplHfSzqmbvtWTw6wRiTBlIDSLmpo1XHvWPM0an_N6ktkr8iNrRtYQAqWPvfHKMhityf02HYc46dwr46xGnnRjVT_Qad-BzC-MxYcOeazYY9iP44swyLUZg6AJ6TjBiiYt7mjKgu8QoRHgIciWuKMrH8V1Q';

        // --- GLOBAL STATE ---
        let allLeakPoints = [];

        // --- CLOCK ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').innerText = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- API HELPER ---
        async function fetchReport(reportPath) {
            try {
                const url = `${API_BASE}/api/services/app/Report/GetReportDataNoCount`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': AUTH_TOKEN,
                        'X-XSRF-TOKEN': XSRF_TOKEN,
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        reportPath: reportPath,
                        page: 0,
                        format: 'HTML',
                        parameters: {}
                    })
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error: ${res.status}`);
                }
                const data = await res.json();
                return data?.result?.items || [];
            } catch (e) {
                console.error("Fetch Error:", e);
                return [];
            }
        }

        // --- API lấy dữ liệu điểm chảy theo tháng (GetSuaChuaSuCoOfNgay) ---
        async function fetchDiemChayTongHop() {
            try {
                // Tính tuNgay (ngày đầu tháng) và denNgay (ngày cuối tháng hiện tại)
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                // Format dd/MM/yyyy
                const formatDate = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };

                const tuNgay = encodeURIComponent(formatDate(firstDay));
                const denNgay = encodeURIComponent(formatDate(lastDay));

                const url = `${API_BASE}/api/services/app/BCTH_MangCap4/GetSuaChuaSuCoOfNgay?tuNgay=${tuNgay}&denNgay=${denNgay}`;
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'accept': 'text/plain',
                        'Authorization': AUTH_TOKEN,
                        'X-XSRF-TOKEN': XSRF_TOKEN,
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error: ${res.status}`);
                }
                const data = await res.json();
                return data?.result || [];
            } catch (e) {
                console.error("Fetch DiemChay Error:", e);
                return [];
            }
        }

        // --- DATA PROCESSING ---
        async function reloadData() {
            document.getElementById('loading').classList.add('active');

            // Gọi song song 3 API:
            // 1. API mới cho điểm chảy tháng (SoDiemChay, DaNghiemThu, ChuaNghiemThu)
            // 2. API cũ để lấy 2 trường nghe dò
            // 3. API chi tiết điểm chảy chưa hoàn thành
            const [diemChayList, summaryData, detailData] = await Promise.all([
                fetchDiemChayTongHop(),
                fetchReport('tt.dktt_TongHopDiemChays'),
                fetchReport('tt.dktt_TongHopDiemChayChuaHoanThanhs')
            ]);

            // Tính tổng từ danh sách điểm chảy trả về (tham khảo BcthTraCuuTongHopDiemChays.kt)
            const tongHop = {
                SoDiemChay: diemChayList.reduce((sum, item) => sum + (item.SoDiemChay || 0), 0),
                DaNghiemThu: diemChayList.reduce((sum, item) => sum + (item.DaNghiemThu || 0), 0),
                ChuaNghiemThu: diemChayList.reduce((sum, item) => sum + (item.ChuaNghiemThu || 0), 0)
            };

            // Lấy 2 trường nghe dò từ API cũ
            const summary = summaryData[0] || {
                SoLuongNgheDoTrongThang: 0,
                SoLuongViTriDangNgheDo: 0
            };

            const total = tongHop.SoDiemChay;
            const done = tongHop.DaNghiemThu;
            const pending = tongHop.ChuaNghiemThu;
            const listeningCount = summary.SoLuongNgheDoTrongThang || 0;
            const listeningLocs = summary.SoLuongViTriDangNgheDo || 0;

            const validDetails = detailData.filter(i => i.MaDiemChay);
            validDetails.sort((a, b) => new Date(a.ThoiGianTiepNhan) - new Date(b.ThoiGianTiepNhan));
            allLeakPoints = validDetails;

            // Update UI - Stats
            document.getElementById('val-total').innerText = total;
            document.getElementById('val-done').innerText = done;
            document.getElementById('val-pending').innerText = pending;
            document.getElementById('val-listening-count').innerText = listeningCount;
            document.getElementById('val-listening-loc').innerText = listeningLocs;

            // Render All Items Table
            const allBody = document.getElementById('all-body');
            allBody.innerHTML = '';
            validDetails.forEach((item, index) => {
                allBody.appendChild(createRow(item, index + 1));
            });
            document.getElementById('all-count').innerText = `Tổng: ${validDetails.length}`;

            document.getElementById('loading').classList.remove('active');
        }

        function createRow(item, stt) {
            const tr = document.createElement('tr');
            tr.className = "group transition-all duration-200 hover:bg-blue-50/50";
            const isOverdue = item.QuaHanKhaoSat === 1;
            const receivedDate = new Date(item.ThoiGianTiepNhan);
            const formattedDate = receivedDate.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const technician = item.MaNhanVienKyThuat || 'N/A';

            const bgCell = "bg-slate-50/50 group-hover:bg-transparent transition-colors";
            // STT từ 1-5 màu đỏ, còn lại màu xám
            const sttColor = stt <= 5 ? 'text-red-600' : 'text-slate-500';

            tr.innerHTML = `
                <td class="px-3 py-2 text-center font-bold ${sttColor} rounded-l-xl ${bgCell}">${stt}</td>
                <td class="px-3 py-2 font-bold text-slate-900 ${bgCell}">${item.MaDiemChay}</td>
                <td class="px-3 py-2 ${bgCell}"><div class="max-w-[25vw]" title="${item.ViTri}">${item.ViTri}</div></td>
                <td class="${bgCell} text-slate-600">${item.SoDienThoai || 'N/A'}</td>
                <td class="${bgCell} text-slate-500 font-medium">${formattedDate}</td>
                <td class="${bgCell} text-slate-700 font-semibold">${technician}</td>
                <td class="px-3 py-2 text-center rounded-r-xl ${bgCell}">
                    <span class="px-2 py-1 rounded-full text-xs font-bold ${isOverdue ? 'bg-red-100 text-red-600 badge-overdue' : 'bg-amber-100 text-amber-600'}">
                        ${isOverdue ? 'Quá hạn khảo sát' : 'Chưa nghiệm thu'}
                    </span>
                </td>
            `;
            return tr;
        }

        // --- CHARTS --- (ĐÃ BỎ)
        // function updateCharts(total, done, pending, listeningCount, listeningLocs) {
        //     // Đã loại bỏ phần biểu đồ theo yêu cầu
        // }

        // Modal logic đã bỏ theo yêu cầu

        // --- INITIALIZATION ---
        window.onload = () => {
            reloadData();
            updateFocus();
        };
        setInterval(reloadData, 300000);

        // --- NAVIGATION & INPUT ---
        const focusableSelectors = '.focusable';
        let focusIndex = 0;

        function getFocusables() {
            return Array.from(document.querySelectorAll(focusableSelectors));
        }

        function updateFocus() {
            const els = getFocusables();
            if (els.length === 0) return;
            if (focusIndex < 0) focusIndex = els.length - 1;
            if (focusIndex >= els.length) focusIndex = 0;
            els.forEach(el => el.classList.remove('focused'));
            els[focusIndex].classList.add('focused');
            els[focusIndex].focus();
        }

        window.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' || e.keyCode === 10009 || e.key === 'Back') {
                window.parent.postMessage({ type: 'back' }, '*');
                return;
            }
        });
    </script>
</body>

</html>