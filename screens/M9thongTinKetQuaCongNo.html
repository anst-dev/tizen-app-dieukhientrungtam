<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Báo Cáo Công Nợ - Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1a1a1a",
                        secondary: "#6b7280",
                        "success-color": "#059669",
                        "danger-color": "#ea580c",
                        "border-color": "#e5e7eb",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #E2E8F0;
            border-top-color: #059669;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-white text-gray-900 font-sans h-screen w-screen overflow-hidden flex flex-col">
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay active">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: #64748B; font-size: 18px;">Đang tải dữ liệu...</p>
    </div>

    <header class="bg-white border-b border-border-color flex-shrink-0">
        <div class="max-w-full mx-auto px-6 py-3 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight text-black">Báo Cáo Công Nợ</h1>
                <p class="text-sm text-gray-500 mt-1">Dữ liệu thời gian thực</p>
            </div>
            <div class="text-right">
                <div id="display-date" class="text-2xl font-mono font-medium tracking-tight">--/--/----</div>
                <div id="display-time" class="text-sm text-gray-400">--:--</div>
            </div>
        </div>
    </header>
    <main class="flex-grow overflow-auto w-[95%] mx-auto px-6 py-4">
        <div
            class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-12 divide-y lg:divide-y-0 lg:divide-x divide-gray-200">
            <!-- KHU VỰC VINH -->
            <div class="space-y-10 lg:pr-6">
                <div class="border-b-2 border-black pb-2">
                    <h2 class="text-4xl font-black uppercase tracking-tight text-black">Khu vực Vinh</h2>
                </div>
                <!-- Kỳ hiện tại - Vinh -->
                <div class="space-y-4">
                    <h3 id="vinh-ky-title"
                        class="text-xl font-semibold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">
                        Tháng --/----</h3>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="flex flex-col">
                            <span class="text-base text-gray-500 mb-1">Phát sinh</span>
                            <span id="vinh-phatsinh"
                                class="text-5xl lg:text-6xl font-bold text-gray-900 tracking-tighter">--</span>
                        </div>
                        <div class="grid grid-cols-2 gap-8 pt-2">
                            <div class="flex flex-col border-l-4 border-success-color pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Đã thu</span>
                                <span id="vinh-dathu"
                                    class="text-3xl lg:text-4xl font-bold text-success-color tracking-tight">--</span>
                            </div>
                            <div class="flex flex-col border-l-4 border-danger-color pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Còn nợ</span>
                                <span id="vinh-conno"
                                    class="text-3xl lg:text-4xl font-bold text-danger-color tracking-tight">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full h-px bg-gray-100"></div>
                <!-- Năm hiện tại - Vinh -->
                <div class="space-y-4 opacity-50 grayscale">
                    <h3 id="vinh-nam-title"
                        class="text-xl font-semibold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">
                        Năm ----</h3>
                    <div class="grid grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 mb-1">Đầu kỳ</span>
                            <span id="vinh-nam-dauky" class="text-2xl font-bold text-gray-300">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 mb-1">Đã thu</span>
                            <span id="vinh-nam-dathu" class="text-2xl font-bold text-gray-300">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 mb-1">Còn nợ</span>
                            <span id="vinh-nam-conno" class="text-2xl font-bold text-gray-300">--</span>
                        </div>
                    </div>
                </div>
                <div class="w-full h-px bg-gray-100"></div>
                <!-- Trước năm - Vinh -->
                <div class="space-y-4">
                    <h3 id="vinh-truoc-title"
                        class="text-xl font-semibold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">
                        Trước ----</h3>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="flex flex-col">
                            <span class="text-base text-gray-500 mb-1">Đầu kỳ</span>
                            <span id="vinh-truoc-dauky"
                                class="text-4xl font-bold text-gray-800 tracking-tight">--</span>
                        </div>
                        <div class="grid grid-cols-2 gap-8 pt-2">
                            <div class="flex flex-col border-l-4 border-gray-200 pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Đã thu</span>
                                <span id="vinh-truoc-dathu"
                                    class="text-3xl font-bold text-success-color tracking-tight">--</span>
                            </div>
                            <div class="flex flex-col border-l-4 border-gray-200 pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Còn nợ</span>
                                <span id="vinh-truoc-conno"
                                    class="text-3xl font-bold text-danger-color tracking-tight">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KHU VỰC MIỀN TÂY -->
            <div class="space-y-10 lg:pl-6 pt-8 lg:pt-0">
                <div class="border-b-2 border-black pb-2">
                    <h2 class="text-4xl font-black uppercase tracking-tight text-black">Khu vực Miền Tây</h2>
                </div>
                <!-- Kỳ hiện tại - MT -->
                <div class="space-y-4">
                    <h3 id="mt-ky-title"
                        class="text-xl font-semibold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">
                        Tháng --/----</h3>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="flex flex-col">
                            <span class="text-base text-gray-500 mb-1">Phát sinh</span>
                            <span id="mt-phatsinh"
                                class="text-5xl lg:text-6xl font-bold text-gray-900 tracking-tighter">--</span>
                        </div>
                        <div class="grid grid-cols-2 gap-8 pt-2">
                            <div class="flex flex-col border-l-4 border-success-color pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Đã thu</span>
                                <span id="mt-dathu"
                                    class="text-3xl lg:text-4xl font-bold text-success-color tracking-tight">--</span>
                            </div>
                            <div class="flex flex-col border-l-4 border-danger-color pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Còn nợ</span>
                                <span id="mt-conno"
                                    class="text-3xl lg:text-4xl font-bold text-danger-color tracking-tight">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full h-px bg-gray-100"></div>
                <!-- Năm hiện tại - MT -->
                <div class="space-y-4 opacity-50 grayscale">
                    <h3 id="mt-nam-title"
                        class="text-xl font-semibold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">
                        Năm ----</h3>
                    <div class="grid grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 mb-1">Đầu kỳ</span>
                            <span id="mt-nam-dauky" class="text-2xl font-bold text-gray-300">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 mb-1">Đã thu</span>
                            <span id="mt-nam-dathu" class="text-2xl font-bold text-gray-300">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 mb-1">Còn nợ</span>
                            <span id="mt-nam-conno" class="text-2xl font-bold text-gray-300">--</span>
                        </div>
                    </div>
                </div>
                <div class="w-full h-px bg-gray-100"></div>
                <!-- Trước năm - MT -->
                <div class="space-y-4">
                    <h3 id="mt-truoc-title"
                        class="text-xl font-semibold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">
                        Trước ----</h3>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="flex flex-col">
                            <span class="text-base text-gray-500 mb-1">Đầu kỳ</span>
                            <span id="mt-truoc-dauky" class="text-4xl font-bold text-gray-800 tracking-tight">--</span>
                        </div>
                        <div class="grid grid-cols-2 gap-8 pt-2">
                            <div class="flex flex-col border-l-4 border-gray-200 pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Đã thu</span>
                                <span id="mt-truoc-dathu"
                                    class="text-3xl font-bold text-success-color tracking-tight">--</span>
                            </div>
                            <div class="flex flex-col border-l-4 border-gray-200 pl-4">
                                <span class="text-sm font-medium text-gray-500 uppercase">Còn nợ</span>
                                <span id="mt-truoc-conno"
                                    class="text-3xl font-bold text-danger-color tracking-tight">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG
        const API_HOST = 'https://unsupercilious-leonarda-unreaving.ngrok-free.dev';
        const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjY3MSIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJuaG1hbmgiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJuaG1hbmhAbmF3YXNjby5jb20udm4iLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6Ik9DRzQ1WDdXVVVTSlE1VlFUMjNNVkxXTVhMV0MzUktVIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoixJDEg25nIGvDvSBuZ2jhu4kiLCJzdWIiOiI2NzEiLCJqdGkiOiJjNGYyOTBlMy02MDg0LTRhZGItOGZjNC1hMWZlNzAyZWM1OTQiLCJpYXQiOjE3NTA2NzAwMTYsIm5iZiI6MTc1MDY3MDAxNiwiZXhwIjoyMDY2MDMwMDE2LCJpc3MiOiJFUlAiLCJhdWQiOiJFUlAifQ.ou9LMHMJw-D-YaRy28_sVDqZRDf1EY7Sl-gWXfx6cnQ';
        const XSRF_TOKEN = 'CfDJ8FNXrp6ZgvRLllnTFj9VlGLf01D9pf_xzEQvLYeYhCUYil5NJiYOf41qk9PUl4_3hQrdGktJ9diSRV9elA0AXdz_wSxOQKZeFW1WA-hZZB_y0BYZm094QPX7Lg7rkjZP_wIo7XFSq9JifB3xkgLzEQTNi_NM0A8aCHYgOKl7ujCnF09eMK1gpyzxFHvaJSZrbA';

        // HELPERS
        const $ = (id) => document.getElementById(id);
        const formatMoney = (num) => num ? Math.round(num).toLocaleString('vi-VN') : '0';

        // Format DateTime từ API
        function formatDateTime(dateString) {
            if (!dateString) return { date: '--/--/----', time: '--:--' };
            const date = new Date(dateString);
            return {
                date: date.toLocaleDateString('vi-VN'),
                time: date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
            };
        }

        // RENDER DATA
        function renderData(data) {
            // Cập nhật thời gian từ API
            const { date, time } = formatDateTime(data.thoiGianTinh);
            $('display-date').textContent = date;
            $('display-time').textContent = time;

            const kyTitle = `Tháng ${data.thang}/${data.nam}`;
            const namTitle = `Năm ${data.nam}`;
            const truocTitle = `Trước ${data.nam}`;

            // === KHU VỰC VINH ===
            // Kỳ hiện tại
            $('vinh-ky-title').textContent = kyTitle;
            $('vinh-phatsinh').textContent = formatMoney(data.tongTien_ThangHienTai_Vinh);
            $('vinh-dathu').textContent = formatMoney(data.tongTien_ThangHienTai_DaThu_Vinh);
            $('vinh-conno').textContent = formatMoney(data.tongTien_ThangHienTai_ConNo_Vinh);

            // Năm hiện tại
            $('vinh-nam-title').textContent = namTitle;
            $('vinh-nam-dauky').textContent = formatMoney(data.tongTien_TrongNam_Vinh);
            $('vinh-nam-dathu').textContent = formatMoney(data.tongTien_TrongNam_DaThu_Vinh);
            $('vinh-nam-conno').textContent = formatMoney(data.tongTien_TrongNam_ConNo_Vinh);

            // Trước năm
            $('vinh-truoc-title').textContent = truocTitle;
            $('vinh-truoc-dauky').textContent = formatMoney(data.tongTien_NamTruoc_Vinh);
            $('vinh-truoc-dathu').textContent = formatMoney(data.tongTien_NamTruoc_DaThu_Vinh);
            $('vinh-truoc-conno').textContent = formatMoney(data.tongTien_NamTruoc_ConNo_Vinh);

            // === KHU VỰC MIỀN TÂY ===
            // Kỳ hiện tại
            $('mt-ky-title').textContent = kyTitle;
            $('mt-phatsinh').textContent = formatMoney(data.tongTien_ThangHienTai_MT);
            $('mt-dathu').textContent = formatMoney(data.tongTien_ThangHienTai_DaThu_MT);
            $('mt-conno').textContent = formatMoney(data.tongTien_ThangHienTai_ConNo_MT);

            // Năm hiện tại
            $('mt-nam-title').textContent = namTitle;
            $('mt-nam-dauky').textContent = formatMoney(data.tongTien_TrongNam_MT);
            $('mt-nam-dathu').textContent = formatMoney(data.tongTien_TrongNam_DaThu_MT);
            $('mt-nam-conno').textContent = formatMoney(data.tongTien_TrongNam_ConNo_MT);

            // Trước năm
            $('mt-truoc-title').textContent = truocTitle;
            $('mt-truoc-dauky').textContent = formatMoney(data.tongTien_NamTruoc_MT);
            $('mt-truoc-dathu').textContent = formatMoney(data.tongTien_NamTruoc_DaThu_MT);
            $('mt-truoc-conno').textContent = formatMoney(data.tongTien_NamTruoc_ConNo_MT);

            console.log('[CongNo] Data rendered successfully');
        }

        // FETCH DATA
        async function fetchData() {
            try {
                const url = `${API_HOST}/api/services/app/Dashboard/GetKetQuaDoanhThu`;
                const res = await fetch(url, {
                    headers: {
                        'Authorization': AUTH_TOKEN,
                        'X-XSRF-TOKEN': XSRF_TOKEN,
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.success && data.result) {
                    renderData(data.result);
                    console.log('[CongNo] Fetched data:', data.result);
                } else {
                    throw new Error('Dữ liệu không hợp lệ');
                }
            } catch (err) {
                console.error('[CongNo] Error:', err);
            } finally {
                $('loading').classList.remove('active');
            }
        }

        // BACK NAVIGATION
        window.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' || e.keyCode === 10009 || e.key === 'Back') {
                window.parent.postMessage({ type: 'back' }, '*');
                e.preventDefault();
                return;
            }
        });

        // INIT
        fetchData();
        setInterval(fetchData, 60000); // Refresh mỗi 60 giây
    </script>

</body>

</html>